<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="PREF_OFR_SLOTS_UP_TRG" directorySegmentName="seg_0" id="27802E12-7A80-4B29-7E9D-416B43C0FD33">
<createdBy>Bart≈Çomiej Krawczyk</createdBy>
<createdTime>2022-05-17 09:01:50 UTC</createdTime>
<ownerDesignName>BD2C049</ownerDesignName>
<actions>UPDATE</actions>
<body><![CDATA[DECLARE
    v_preferences   NUMBER;
    v_slots         NUMBER;
    PRAGMA          AUTONOMOUS_TRANSACTION;
BEGIN
    -- Count all preferences chosen
    SELECT 	COUNT(*)
    INTO    v_preferences
    FROM 	preferences p 
    WHERE 	p.candidate_id != :new.candidate_id
        AND p.course_code = :new.course_code 
        AND p.registration_code = :new.registration_code
        AND p.result = 'Y';

    -- Get the available slots for course in that registration
    SELECT 	available_slots 
    INTO    v_slots
    FROM 	offers o 
    WHERE 	o.course_code = :new.course_code 
        AND o.registration_code = :new.registration_code;

    -- Make sure the list of enrolled students is smaller/(equal) than the number
    -- of available slots
	IF v_preferences >= v_slots THEN
		raise_application_error(-20001, 'Not enough slots for the offer!');
	END IF;
END;]]></body>
<triggerTime>BEFORE</triggerTime>
<condition><![CDATA[new.result = 'Y' AND old.result != new.result]]></condition>
<table>64116F9A-D9BA-B4DD-769D-EBACFDB2975A</table>
</TriggerOraclev10g>
